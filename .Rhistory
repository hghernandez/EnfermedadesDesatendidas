mutate(cluster= case_when(`Pr(z != E(Ii))` > 0.05 ~ 'no significativo',
TRUE ~ mean))
#Cargo la cartografia de los departamentos
deptos <- st_read(dsn= "cartografia/deptos",
layer = "pxdptodatosok")
#Arreglo las geometrias
deptos <- st_make_valid(deptos)
#Cargo la cartografia de las provincias
pcias <- st_read(dsn= "cartografia/provincias",
layer = "pxpciadatosok")
#Arreglo las geometrias
pcias <- st_make_valid(pcias)
#Selecciono caba como provincia
caba <- pcias %>% filter(link == '02')
#Excluyo antartida y caba
deptos <- deptos %>% filter(!link %in% c(94028,94021) & codpcia != '02')
#Uno los departamentos y caba
deptos <- deptos %>%
bind_rows(caba)
#Arreglo los datos
deptos <- deptos %>%
mutate(link= case_when(link== '02' ~ '02000', TRUE ~ link),
codpcia= case_when(link== '02000' ~ '02',TRUE ~ codpcia),
departamen= case_when(link== '02000' ~ 'CABA',TRUE ~ departamen))
#Agrego los datos de ambos sexos
deptos <- deptos %>%
left_join(tasas_chagas_df %>% filter(grepl("3.",sexo)) %>% select(link,RME,suavizadas,mean,cluster))
#Calculo los quintiles
deptos$suavizadas_agrup <- cut(deptos$suavizadas,quantile(deptos$suavizadas,probs= c(0,0.2,0.4,0.6,0.8,1)),
dig.lab = 4)
labeler <- function(labels){
#Guardo el nivel
levels <- levels(labels)
#Edito el nivel
levels <- stringr::str_remove(string = levels, fixed("("))
levels <- stringr::str_remove(string = levels, fixed("]"))
levels <- stringr::str_remove(string = levels, fixed("["))
levels <- stringr::str_replace(string = levels,pattern = ",",replacement = "-")
#Edito las etiquetas
labels <- stringr::str_remove(string = labels, fixed("("))
labels <- stringr::str_remove(string = labels, fixed("]"))
labels <- stringr::str_remove(string = labels, fixed("["))
labels <- stringr::str_replace(string = labels,pattern = ",",replacement = "-")
return(levels(factor(labels,levels = levels)))
}
colores_personalizados <- colorFactor(
palette = c("red", "blue", "lightpink", "skyblue2", "white"),
domain = c("High-High", "Low-Low", "High-Low", "Low-High", "no significativo")
)
mapa_chagas <-leaflet(deptos) %>%
addTiles(urlTemplate = "https://wms.ign.gob.ar/geoserver/gwc/service/tms/1.0.0/capabaseargenmap@EPSG%3A3857@png/{z}/{x}/{-y}.png",
tileOptions(tms = TRUE,maxZoom = 14),attribution = '<a target="_blank" href="https://www.ign.gob.ar/argenmap/argenmap.jquery/docs/#datosvectoriales" style="color: black; text-decoration: underline; font-weight: normal;">Datos IGN Argentina // OpenStreetMap</a>') %>%
addPolygons(fill = colores_personalizados(deptos$mean),
fillColor = colores_personalizados(deptos$mean),
fillOpacity = 0.7,
stroke = TRUE,
weight = 1,
color = "grey",
popup = paste0(deptos$departamen,"\n",deptos$mean),
group= "Cluster") %>%
addLegend(position = "bottomright", # Posición de la leyenda
colors = c("red", "blue", "lightpink", "skyblue2", "white"),
labels = c("High-High", "Low-Low", "High-Low", "Low-High", "no significativo"),
title = "Cluster",
group = "Cluster")
pal <- RColorBrewer::brewer.pal(5,"Blues")
mapa_chagas <- mapa_chagas %>%
addPolygons(fill= deptos$suavizadas_agrup,
color= pal,
fillOpacity = 0.7,
stroke = FALSE,
weight = 1,
popup = paste0(deptos$departamen,"\n",deptos$suavizadas),
group= "Suavizadas") %>%
addLegend(position = "bottomright", # Posición de la leyenda
colors = pal,
labels = labeler(deptos$suavizadas_agrup),
title = "RME suavizadas",
group = "Suavizadas")
mapa_chagas <- mapa_chagas %>%
addPolygons(fill = colores_personalizados(deptos$cluster),
fillColor = colores_personalizados(deptos$cluster),
fillOpacity = 0.7,
stroke = TRUE,
weight = 1,
color = "grey",
popup = paste0(deptos$departamen,"\n",deptos$cluster),
group= "Cluster Test") %>%
addLegend(position = "bottomright", # Posición de la leyenda
colors = c("red", "blue", "lightpink", "skyblue2", "white"),
labels = c("High-High", "Low-Low", "High-Low", "Low-High", "no significativo"),
title = "Cluster Test",
group = "Cluster Test")
mapa_chagas %>%
addLayersControl(
overlayGroups = c("Suavizadas","Cluster","Cluster Test"),
position = "bottomleft",
options = layersControlOptions(collapsed = F)
)
library(tidyverse)
library(R.utils)
library(foreign)
library(sf)
library(epitools)
library(spdep)
load("datosMort/data.RData")
unique(casos$enf_desa_sub)
enf <- "02.Leishmaniasis"
get(enf)
enf <- casos %>%
filter(enf_desa_sub== enf)
enf
source("~/Mis Documentos/EnfermedadesDesatendidas/tasas/calculo_tasas.R", echo=TRUE)
save(tasas_enf_df,file= paste0("tasas/tasas_",evento,"_suav.RData"))
View(tasas_enf_df)
library(tidyverse)
library(R.utils)
library(foreign)
library(sf)
library(epitools)
library(spdep)
load("datosMort/data.RData")
unique(casos$enf_desa_sub)
evento <- "11.Equinococosis"
substring(evento,4,stringr::str_length(evento))
source("~/Mis Documentos/EnfermedadesDesatendidas/tasas/calculo_tasas.R", echo=TRUE)
View(tasas_enf_df)
library(tidyverse)
library(R.utils)
library(foreign)
library(sf)
library(epitools)
library(spdep)
library(leaflet)
load(file="tasas/tasas_Equinococosis_suav.RData")
matriz <- read.gal("matriz de vecindad/matriz")
tasas_enf_df[is.na(tasas_enf_df)] <- 0
sexo = unique(tasas_enf_df$sexo)
for(sexo in sexo){
tasas_enf_df[tasas_enf_df$sexo== sexo,c(10:14)] <- cbind(attr(localmoran(tasas_enf_df$suavizadas[tasas_enf_df$sexo== sexo[1]],nb2listw(matriz,style = "B")),"quadr"),
localmoran(tasas_enf_df$suavizadas[tasas_enf_df$sexo== sexo[1]],nb2listw(matriz,style = "B"))[,c(1,5)]
)
print(sexo)
}
tasas_enf_df <- tasas_enf_df %>%
mutate(cluster= case_when(`Pr(z != E(Ii))` > 0.05 ~ 'no significativo',
TRUE ~ mean))
deptos <- st_read(dsn= "cartografia/deptos",
layer = "pxdptodatosok")
#Arreglo las geometrias
deptos <- st_make_valid(deptos)
#Cargo la cartografia de las provincias
pcias <- st_read(dsn= "cartografia/provincias",
layer = "pxpciadatosok")
#Arreglo las geometrias
pcias <- st_make_valid(pcias)
#Selecciono caba como provincia
caba <- pcias %>% filter(link == '02')
#Excluyo antartida y caba
deptos <- deptos %>% filter(!link %in% c(94028,94021) & codpcia != '02')
#Uno los departamentos y caba
deptos <- deptos %>%
bind_rows(caba)
deptos <- deptos %>%
mutate(link= case_when(link== '02' ~ '02000', TRUE ~ link),
codpcia= case_when(link== '02000' ~ '02',TRUE ~ codpcia),
departamen= case_when(link== '02000' ~ 'CABA',TRUE ~ departamen))
deptos <- deptos %>%
left_join(tasas_enf_df %>% filter(grepl("3.",sexo)) %>% select(link,RME,suavizadas,mean,cluster))
deptos$suavizadas_agrup <- cut(deptos$suavizadas,quantile(deptos$suavizadas,probs= c(0,0.2,0.4,0.6,0.8,1)),
dig.lab = 4)
deptos$suavizadas_agrup <- cut(deptos$suavizadas,unique(quantile(deptos$suavizadas,probs= c(0,0.2,0.4,0.6,0.8,1)),
dig.lab = 4))
labeler <- function(labels){
#Guardo el nivel
levels <- levels(labels)
#Edito el nivel
levels <- stringr::str_remove(string = levels, fixed("("))
levels <- stringr::str_remove(string = levels, fixed("]"))
levels <- stringr::str_remove(string = levels, fixed("["))
levels <- stringr::str_replace(string = levels,pattern = ",",replacement = "-")
#Edito las etiquetas
labels <- stringr::str_remove(string = labels, fixed("("))
labels <- stringr::str_remove(string = labels, fixed("]"))
labels <- stringr::str_remove(string = labels, fixed("["))
labels <- stringr::str_replace(string = labels,pattern = ",",replacement = "-")
return(levels(factor(labels,levels = levels)))
}
colores_personalizados <- colorFactor(
palette = c("red", "blue", "lightpink", "skyblue2", "white"),
domain = c("High-High", "Low-Low", "High-Low", "Low-High", "no significativo")
)
mapa_enf <-leaflet(deptos) %>%
addTiles(urlTemplate = "https://wms.ign.gob.ar/geoserver/gwc/service/tms/1.0.0/capabaseargenmap@EPSG%3A3857@png/{z}/{x}/{-y}.png",
tileOptions(tms = TRUE,maxZoom = 14),attribution = '<a target="_blank" href="https://www.ign.gob.ar/argenmap/argenmap.jquery/docs/#datosvectoriales" style="color: black; text-decoration: underline; font-weight: normal;">Datos IGN Argentina // OpenStreetMap</a>') %>%
addPolygons(fill = colores_personalizados(deptos$mean),
fillColor = colores_personalizados(deptos$mean),
fillOpacity = 0.7,
stroke = TRUE,
weight = 1,
color = "grey",
popup = paste0(deptos$departamen,"\n",deptos$mean),
group= "Cluster") %>%
addLegend(position = "bottomright", # Posición de la leyenda
colors = c("red", "blue", "lightpink", "skyblue2", "white"),
labels = c("High-High", "Low-Low", "High-Low", "Low-High", "no significativo"),
title = "Cluster",
group = "Cluster")
pal <- RColorBrewer::brewer.pal(5,"Blues")
mapa_enf <- mapa_enf %>%
addPolygons(fill= deptos$suavizadas_agrup,
color= pal,
fillOpacity = 0.7,
stroke = FALSE,
weight = 1,
popup = paste0(deptos$departamen,"\n",deptos$suavizadas),
group= "Suavizadas") %>%
addLegend(position = "bottomright", # Posición de la leyenda
colors = pal,
labels = labeler(deptos$suavizadas_agrup),
title = "RME suavizadas",
group = "Suavizadas")
pa
pal
deptos$suavizadas_agrup
pal
mapa_enf <- mapa_enf %>%
addPolygons(fill= deptos$suavizadas_agrup,
color= pal,
fillOpacity = 0.7,
stroke = FALSE,
weight = 1,
popup = paste0(deptos$departamen,"\n",deptos$suavizadas),
group= "Suavizadas") %>%
addLegend(position = "bottomright", # Posición de la leyenda
colors = pal[1:4],
labels = labeler(deptos$suavizadas_agrup),
title = "RME suavizadas",
group = "Suavizadas")
mapa_enf <- mapa_enf %>%
addPolygons(fill = colores_personalizados(deptos$cluster),
fillColor = colores_personalizados(deptos$cluster),
fillOpacity = 0.7,
stroke = TRUE,
weight = 1,
color = "grey",
popup = paste0(deptos$departamen,"\n",deptos$cluster),
group= "Cluster Test") %>%
addLegend(position = "bottomright", # Posición de la leyenda
colors = c("red", "blue", "lightpink", "skyblue2", "white"),
labels = c("High-High", "Low-Low", "High-Low", "Low-High", "no significativo"),
title = "Cluster Test",
group = "Cluster Test")
mapa_enf %>%
addLayersControl(
overlayGroups = c("Suavizadas","Cluster","Cluster Test"),
position = "bottomleft",
options = layersControlOptions(collapsed = F)
)
library(tidyverse)
library(R.utils)
library(foreign)
library(sf)
library(epitools)
library(spdep)
load("datosMort/data.RData")
unique(casos$enf_desa_sub)
evento <- "18.Lepra"
enf <- casos %>%
filter(enf_desa_sub== evento)
pob_deptos <- loadObject("PoblacionesEstimadas/pobdeptos0125.Rbin")
#Armo la poblacion para todo CABA
pob_caba <- pob_deptos %>%
filter(codprov== 2) %>%
group_by(ano,codprov,sexo,gredad) %>%
summarise(poblacion= sum(poblacion))%>%
mutate(coddep= 000,
nomdep= 'Total CABA') %>%
as.data.frame()
str(pob_caba)
#Armo la poblacion para todo el pais excepto caba
pob_sin_caba <- pob_deptos %>%
filter(codprov!= 2) %>%
group_by(ano,codprov,coddep,nomdep,sexo,gredad) %>%
summarise(poblacion= sum(poblacion)) %>%
as.data.frame()
str(pob_sin_caba)
#Unifico todo
pob_deptos <- pob_caba %>%
bind_rows(pob_sin_caba)
#Armo una funcion para fixear los codigos
fix_cod <- function(x){
x <- ifelse(stringr::str_length(x)== 1,paste0('00',x),
ifelse(stringr::str_length(x)== 2,paste0('0',x),as.character(x)))
return(x)
}
str(pob_deptos)
#Fixeo coddep
pob_deptos <- pob_deptos %>%
mutate(coddep= fix_cod(coddep),
codprov= ifelse(codprov < 10,paste0('0',codprov),codprov))
#Uno los casos y la poblacion estimada
names(casos)
names(pob_deptos)
enf <- pob_deptos %>%
filter(ano >= 2004 & ano <= 2018) %>%
left_join(enf, by= c("ano","codprov"="provres","coddep"="depres","sexo","gredad"="edadquinq")) %>%
mutate(link= paste0(codprov,coddep)) %>%
fill(enf_desa_sub,.direction = "downup") %>%
fill(enf_desa_tot,.direction = "downup")
#Seteo los valroes NULL a 0
enf[is.na(enf)] <- 0
##%######################################################%##
#                                                          #
####                  Calculo las RME                   ####
#                                                          #
##%######################################################%##
#Standar de casos
std =enf %>%
filter(gredad != '18.Total')%>%
group_by(enf_desa_sub,sexo,gredad) %>%
summarise(casos=sum(casos),
poblacion=sum(poblacion)) %>%
mutate(order= as.numeric(substring(gredad,1,2))) %>%
arrange(sexo,order)
#casos
enf_casos <- enf %>%
filter(gredad != '18.Total')%>%
group_by(link,enf_desa_sub,sexo,gredad) %>%
summarise(casos=sum(casos),
poblacion=sum(poblacion)) %>%
mutate(order= as.numeric(substring(gredad,1,2))) %>%
arrange(link,sexo,order)
#Departamentos = 512
#Sexo= 3
# Lista de 1536 objetos (512*3)
tasas_enf <- list()
for(i in 1:1536){
for(j in 1:3){
tasas_enf[[i]] <- ageadjust.indirect(count = enf_casos[(1+17*(i-1)):(17+17*(i-1)),5],
pop= enf_casos[(1+17*(i-1)):(17+17*(i-1)),6],
stdcount = std[(1+17*(j-1)):(17+17*(j-1)),4],
stdpop= std[(1+17*(j-1)):(17+17*(j-1)),5],
stdrate = std[(1+17*(j-1)):(17+17*(j-1)),4]/std[(1+17*(j-1)):(17+17*(j-1)),5])
}
print(i)
}
#Guardo las tasas en un data frame
tasas_enf_df <- as.data.frame(1:1536)
tasas_enf_df$observados <- 0
tasas_enf_df$esperados <- 0
tasas_enf_df$RME <- 0
tasas_enf_df$ic_inf <- 0
tasas_enf_df$ic_sup <- 0
for(i in 1:1536){
tasas_enf_df[i,]$observados <- tasas_enf[[i]]$sir[1]
tasas_enf_df[i,]$esperados <- tasas_enf[[i]]$sir[2]
tasas_enf_df[i,]$RME <- tasas_enf[[i]]$sir[3]*100
tasas_enf_df[i,]$ic_inf <- tasas_enf[[i]]$sir[4]*100
tasas_enf_df[i,]$ic_sup <- tasas_enf[[i]]$sir[5]*100
print(i)
}
#Agrego el sexo
s <- unique(enf_casos$sexo)
tasas_enf_df$sexo <- rep(s,512)
#Agrego el link
l <- unique(enf_casos$link)
tasas_enf_df$link <- rep(l,each= 3)
#agrego el evento
tasas_enf_df[,1] <- evento
colnames(tasas_enf_df)[1] <- 'Evento'
##%######################################################%##
#                                                          #
####                  Guardo las tasas                  ####
#                                                          #
##%######################################################%##
save(tasas_enf_df,file= paste0("tasas/tasas",substring(evento,4,stringr::str_length(evento)),".RData"))
load(paste0("tasas/tasas",substring(evento,4,stringr::str_length(evento)),".RData"))
##%######################################################%##
#                                                          #
####                 Suavizo las tasas                  ####
#                                                          #
##%######################################################%##
#Excluyo antartida y malvinas
tasas_enf_df <- tasas_enf_df %>%
filter(!link %in% c(94028,94021))
#Cargo la matriz de vecindad
matriz <- read.gal("matriz de vecindad/matriz")
#Suavizo las tasas
sexo = unique(tasas_enf_df$sexo)
for(sexo in sexo){
tasas_enf_df[tasas_enf_df$sexo== sexo,9] <- EBlocal(tasas_enf_df$observados[tasas_enf_df$sexo== sexo],
tasas_enf_df$esperados[tasas_enf_df$sexo== sexo],
matriz)$est*100
print(sexo)
}
colnames(tasas_enf_df)[9] <- 'suavizadas'
#Guardo las tasas
save(tasas_enf_df,file= paste0("tasas/tasas_",substring(evento,4,stringr::str_length(evento)),"_suav.RData"))
knitr::opts_chunk$set(
echo = FALSE,
warning = FALSE,
message = FALSE,
comment = "##",
fig.width = 10
)
```{r}
```{r}
```{r}
ruta <- getwd()
load(paste0(ruta,"tasas/tasas_ntd_suav.RData"))
ruta <- getwd()
load(paste0(ruta,"tasas/tasas_ntd_suav.RData"))
```{r}
getwd()
ruta <- "C:/Users/NaranjaX/Documents/Mis Documentos/EnfermedadesDesatendidas/"
load(paste0(ruta,"tasas/tasas_ntd_suav.RData"))
load(paste0(ruta,"tasas/tasas_02.Leishmaniasis_suav.RData"))
load(paste0(ruta,"tasas/tasas_chagas_suav.RData"))
load(paste0(ruta,"tasas/tasas_Equinococosis_suav.RData"))
load(paste0(ruta,"tasas/tasas_Lepra_suav.RData"))
ruta <- "C:/Users/NaranjaX/Documents/Mis Documentos/EnfermedadesDesatendidas/"
load(paste0(ruta,"tasas/tasas_ntd_suav.RData"))
load(paste0(ruta,"tasas/tasas_02.Leishmaniasis_suav.RData"))
load(paste0(ruta,"tasas/tasas_chagas_suav.RData"))
load(paste0(ruta,"tasas/tasas_Equinococosis_suav.RData"))
load(paste0(ruta,"tasas/tasas_Lepra_suav.RData"))
knitr::opts_chunk$set(
echo = FALSE,
warning = FALSE,
message = FALSE,
comment = "##",
fig.width = 10
)
knitr::include_graphics("articuloprevio.png")
knitr::include_graphics("articuloprevio.png")
library(tidyverse)
library(R.utils)
library(foreign)
library(sf)
library(epitools)
library(spdep)
#Cargo la cartografia de los departamentos
deptos <- st_read(dsn= "cartografia/deptos",
layer = "pxdptodatosok")
#Arreglo las geometrias
deptos <- st_make_valid(deptos)
#Cargo la cartografia de las provincias
pcias <- st_read(dsn= "cartografia/provincias",
layer = "pxpciadatosok")
#Arreglo las geometrias
pcias <- st_make_valid(pcias)
#Selecciono caba como provincia
caba <- pcias %>% filter(link == '02')
#Excluyo antartida y caba
deptos <- deptos %>% filter(!link %in% c(94028,94021) & codpcia != '02')
#Uno los departamentos y caba
deptos <- deptos %>%
bind_rows(caba)
#Arreglo los datos
deptos <- deptos %>%
mutate(link= case_when(link== '02' ~ '02000', TRUE ~ link),
codpcia= case_when(link== '02000' ~ '02',TRUE ~ codpcia),
departamen= case_when(link== '02000' ~ 'CABA',TRUE ~ departamen))
#Armo mapa de matriz de vecindad#
coord <- st_coordinates(deptos)
#Genero la matriz de contiguidad#
neighbors <- poly2nb(deptos)
plot(st_geometry(deptos), border = "lightgrey")
plot.nb(neighbors, st_geometry(deptos), add = TRUE)
knitr::include_graphics("matriz de vecindad/MatrizdeVecindadImagen.png")
knitr::include_graphics("MatrizdeVecindadImagen.png")
knitr::include_graphics("MatrizdeVencidadImagen.png")
knitr::include_graphics("MatrizdeVencidadImagen.png")
knitr::include_graphics("MatrizdeVencidadImagen")
knitr::include_graphics("MatrizdeVencidadImagen.PNG")
knitr::include_graphics(paste0(ruta,"MatrizdeVencidadImagen.png"))
```{r}
library(tidyverse)
library(R.utils)
library(foreign)
library(sf)
library(epitools)
library(spdep)
#Cargo la cartografia de los departamentos
deptos <- st_read(dsn= "cartografia/deptos",
layer = "pxdptodatosok")
#Arreglo las geometrias
deptos <- st_make_valid(deptos)
#Cargo la cartografia de las provincias
pcias <- st_read(dsn= "cartografia/provincias",
layer = "pxpciadatosok")
#Arreglo las geometrias
pcias <- st_make_valid(pcias)
#Selecciono caba como provincia
caba <- pcias %>% filter(link == '02')
#Excluyo antartida y caba
deptos <- deptos %>% filter(!link %in% c(94028,94021) & codpcia != '02')
#Uno los departamentos y caba
deptos <- deptos %>%
bind_rows(caba)
#Arreglo los datos
deptos <- deptos %>%
mutate(link= case_when(link== '02' ~ '02000', TRUE ~ link),
codpcia= case_when(link== '02000' ~ '02',TRUE ~ codpcia),
departamen= case_when(link== '02000' ~ 'CABA',TRUE ~ departamen))
#Armo mapa de matriz de vecindad#
coord <- st_coordinates(deptos)
#Genero la matriz de contiguidad#
neighbors <- poly2nb(deptos)
plot(st_geometry(deptos), border = "lightgrey")
plot.nb(neighbors, st_geometry(deptos), add = TRUE)
